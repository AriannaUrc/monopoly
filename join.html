<!DOCTYPE html>
<html>
<body>

<h2>LET'S PLAY</h2>

  <label for="lname">Create New:</label><br>
  <input type="text" id="lname" name="fname" value="test1234"><br>

  <button id="createButton">Create</button>

<br><br><br>
    <label for="gameID">Game ID:</label><br>
    <input type="text" id="gameID" name="gameID" value="00000"><br><br>
    <label for="gameName">Player Name:</label><br>
    <input type="text" id="gameName" name="gameName" value="test1234"><br>

    <button id="joinButton">Join</button>
<br><br>
    <button id="seeButton">See</button>

<p>If you click the "Submit" button, the form-data will be sent to a page called "/action_page.php".</p>
</body>
<script>
    function refresh()
    {
        iText = document.getElementById("lname").value;
        jID = document.getElementById("gameID").value;
        jName = document.getElementById("gameName").value;
    }


    async function SeeGames()
    {
        //await new Promise((resolve, reject) => {setTimeout(() => {resolve();}, 10000);});
        var authorizationBasic = window.btoa("4IE" + ':' + "Tironi");
        const xhr = new XMLHttpRequest();
        
        //xhr.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
        xhr.withCredentials = true;
        
        //xhr.setRequestHeader('Accept', 'application/json');
        xhr.addEventListener("readystatechange", function(){
            if(this.readyState === 4){
                console.log(this.responseText);
                //console.log("hi")
            }
        })
        
        xhr.open("GET", "https://classe5ID.altervista.org/games/partitaN/7");
        xhr.setRequestHeader('Authorization', 'Basic ' +authorizationBasic);

        xhr.send();
    }


    function CreateNew(name) //returns id;
    {
        return new Promise((resolve, reject) => 
        {
        var authorizationBasic = window.btoa("4IE" + ':' + "Tironi");
        const xhr = new XMLHttpRequest();
        
        //xhr.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
        xhr.withCredentials = true;
        
        //xhr.setRequestHeader('Accept', 'application/json');
        xhr.addEventListener("readystatechange", function(){
            if(this.readyState === 4){
                console.log(this.responseText);
                let res = JSON.parse(this.response);
                let id = parseInt(res.data.id);
                resolve(id);
            }
        })
        
        xhr.open("POST", "https://classe5ID.altervista.org/games/partita/monopoly_Urciuoli_" + name);
        xhr.setRequestHeader('Authorization', 'Basic ' +authorizationBasic);

        xhr.send();
        });
    }


    function joinGame(id, name)
    {
        return new Promise((resolve, reject) => 
        {

        var authorizationBasic = window.btoa("4IE" + ':' + "Tironi");
        const xhr = new XMLHttpRequest();
        xhr.withCredentials = true;

        xhr.addEventListener("readystatechange", function(){
            if(this.readyState === 4){
                console.log(this.responseText);
                let res = JSON.parse(this.response);
                let id = parseInt(res.data.id);
                resolve(id);
            }
        })
        
        xhr.open("POST", "https://classe5ID.altervista.org/games/join/" + id + "/monopoly_Urciuoli_" + name);
        xhr.setRequestHeader('Authorization', 'Basic ' +authorizationBasic);

        xhr.send();
        });
    }

    async function gameAvailable(id)
    {
        return new Promise((resolve, reject) => 
        {
            var authorizationBasic = window.btoa("4IE" + ':' + "Tironi");
            const xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", function(){
                if(this.readyState === 4){
                    console.log(this.responseText);
                }
            })
            
            xhr.onload = () => {
                if (xhr.readyState === xhr.DONE) {
                    if (xhr.status === 200) 
                    {
                        var myArr = JSON.parse(xhr.response);
                        var move = parseInt(myArr.data.play);
                        console.log(move);
                        //console.log(isNaN(move))
                        if((move > 0 && move <= 7))//if there is space for you
                        {
                            console.log("yes!!")
                            resolve(true);
                        }
                        else
                        {
                            resolve(false);
                        }
                    }
                    else{
                        resolve(false);
                    }
                }
            };

            xhr.open("GET", "https://classe5ID.altervista.org/games/mossa/" + id);
            xhr.setRequestHeader('Authorization', 'Basic ' +authorizationBasic);
            
            xhr.send();
            //return false;
        });
    }

    async function lastMove(id)
    {
        return new Promise((resolve, reject) => 
        {
            var authorizationBasic = window.btoa("4IE" + ':' + "Tironi");
            const xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", function(){
                if(this.readyState === 4){
                    console.log(this.responseText);
                }
            })
            
            xhr.onload = () => {
                if (xhr.readyState === xhr.DONE) {
                    if (xhr.status === 200) 
                    {
                        var myArr = JSON.parse(xhr.response);
                        var move = parseInt(myArr.data.play);
                        //console.log(move);
                        //console.log(isNaN(move))
                        resolve(move);
                    }
                    else{
                        resolve(null);
                    }
                }
            };

            xhr.open("GET", "https://classe5ID.altervista.org/games/mossa/" + id);
            xhr.setRequestHeader('Authorization', 'Basic ' +authorizationBasic);
            
            xhr.send();
            //return false;
        });
    }

    function addNumber(id, name, n){
        return new Promise((resolve, reject) => 
        {
            var authorizationBasic = window.btoa("4IE" + ':' + "Tironi");
            const xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", function(){
                if(this.readyState === 4){
                    console.log(this.responseText);
                    resolve();
                }
            })

            xhr.open("POST", "https://classe5ID.altervista.org/games/mossa/" + id + "/monopoly_Urciuoli_" + name + "/" + n);
            xhr.setRequestHeader('Authorization', 'Basic ' +authorizationBasic);
            
            xhr.send();
        });
    }

    var createButton = document.getElementById("createButton"); //https://classe5ID.altervista.org/games/partita/{Username} 
    var joinButton = document.getElementById("joinButton");
    var seeButton = document.getElementById("seeButton");
    var iText
    var jID
    var jName
    var player = 1;

    createButton.addEventListener("click", async () => {
        await refresh();
        let id = await CreateNew(iText);
        //aspetta
        new Promise((resolve, reject) => {setTimeout(() => {resolve();}, 2000);});
        SeeGames();
    });


    joinButton.addEventListener("click", async () => {
        await refresh()
        //console.log(gameAvailable(jID))
        //var avilable = await gameAvailable(jID);
        joinGame(jID, jName);
        console.log("you can join");
        var mov =  parseInt( await lastMove(jID)) ;
        if (isNaN(mov))
        {
            addNumber(jID, iText, 2);
        }
        else{
            mov += 1;
            player = mov;
            addNumber(jID, iText, mov)
        }
        
        //aspetta
        SeeGames();
    });


    seeButton.addEventListener("click", () => {
        //aspetta
        SeeGames();
    });



</script>
</html>
